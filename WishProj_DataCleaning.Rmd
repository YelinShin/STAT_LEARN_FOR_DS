---
title: "R Notebook"
output:
  html_document:
    df_print: paged
---

# TL;dr
1. Many features need to be removed before any analysis are conducted. <br>
2. product variation inventory, merchant rating and merchang rating count seem to be the most important features. Those features about badges may also be helpful but there may be collinearity. <br>

```{r}
options(warn=-1)
library(tidyverse)
library(GGally)
library(plotly)
library(cowplot)
library(ggcorrplot)
```


```{r}
# dt <- read.csv("summer-products-with-rating-and-performance_2020-08", sep="")
# cmd + option + c
str(dt)
```




```{r}
dt <- dt %>% select(-crawl_month,-theme,-product_id,-product_picture,-product_url,-merchant_id,-merchant_profile_picture,-merchant_info_subtitle,-merchant_name,-merchant_title,-urgency_text,-title_orig, -currency_buyer)
summary(dt)
```

# Data Cleaning
##checking NA's
1. Though there are 45 missing values in the details of rating count. It doesn't influence the rating count and average rating we want to look at, so maybe we can keep them for now (and it is very likely that we will drop the details of the rating count columns later) <br>
2. Replace 'na' in 'has_urgency_banner' with 0
```{r}
# 
# cmd + shift + m
dt <- dt %>% mutate(has_urgency_banner = ifelse(is.na(has_urgency_banner),'0',has_urgency_banner))
```


3. clean the sizes 
```{r}
dt %>% select(product_variation_size_id) %>% unique()

```



```{r}
dt <- dt %>%
    mutate(product_variation_size_id = tolower(product_variation_size_id)) %>%
    mutate(product_variation_size_id = gsub(pattern='.',replacement='',
                                            x=product_variation_size_id,fixed=TRUE)) %>%
    mutate(product_variation_size_id = gsub(pattern='(size-*)|(size)',replacement='',
                                            x=product_variation_size_id))  %>%
    mutate(product_variation_size_id = gsub(pattern='.+[-]',replacement='',
                                            x=product_variation_size_id)) %>%
    mutate(product_variation_size_id = ifelse(grepl(pattern='xl',product_variation_size_id),
                                              'xl',product_variation_size_id)) %>%
    mutate(product_variation_size_id = ifelse(grepl(pattern='xs',product_variation_size_id),
                                              'xs',product_variation_size_id)) %>%
    mutate(product_variation_size_id = str_replace(product_variation_size_id,' ','')) %>%
    mutate(product_variation_size_id = ifelse(product_variation_size_id %in% c('s','xs','m','l','xl'),
                                              product_variation_size_id,'NotIdentified'))

```



```{r}
dt %>% select(product_variation_size_id) %>% unique()
```

4. clean the tags (set by the seller, NLP may be helpful to separate the words). Here we are oversimplifying it by counting the number of tags contained. 
```{r}
dt <- dt %>% mutate(tags = sapply(strsplit(tags,','),length))
```

5. fix the color. group the similar clours together. <br>
One thing might be worth looking at is ... whether special colors (not the mainstream ones) actually sell better, because they make people feel special?
```{r}
dt <- dt %>% 
    mutate(product_color = tolower(product_color)) %>%
    mutate(product_color = ifelse(grepl(pattern='red|burgundy|claret|wine|jasper',product_color),
                                  'red',product_color)) %>%
    mutate(product_color = ifelse(grepl(pattern='blue|navy',product_color)
                                  ,'blue',product_color)) %>%
    mutate(product_color = ifelse(grepl(pattern='white',product_color)
                                  ,'white',product_color)) %>%
    mutate(product_color = ifelse(grepl(pattern='green|army',product_color)
                                  ,'green',product_color)) %>%
    mutate(product_color = ifelse(grepl(pattern='black',product_color)
                                  ,'black',product_color)) %>%
    mutate(product_color = ifelse(grepl(pattern='yellow|leopard|gold',product_color),
                                  'yellow',product_color)) %>%
    mutate(product_color = ifelse(grepl(pattern='pink|rose',product_color),
                                  'pink',product_color)) %>%
    mutate(product_color = ifelse(grepl(pattern='grey|gray|silver',product_color),
                                  'gray',product_color)) %>%
    mutate(product_color = ifelse(grepl(pattern='purple|violet',product_color),
                                  'purple',product_color)) %>%
    mutate(product_color = ifelse(grepl(pattern='orange|apricot',product_color),
                                  'orange',product_color)) %>%
    mutate(product_color = ifelse(grepl(pattern='beige|nude|ivory|coffee|brown|khaki|camel',
                                        product_color),'khaki',product_color)) %>%
    mutate(product_color = ifelse(grepl(pattern='floral|multicolor|camouflage|rainbow|star',
                                        product_color),'multicolor',product_color))

```


```{r}
dt <- dt %>% select(-title)

```


```{r}
# check for the number of unique values for each column 
# looks fine - we are good for the next steps
ulst <- lapply(dt, unique)
lengths(ulst)
```

# Feature Engineering 
1. Check for correlations 
```{r}

# cnr = dt %>% select(where(is.numeric)) %>% cor()
# #p-values matrix
# p.values = cor_pmat(dt %>% select(where(is.numeric)))
# 
# ggcorrplot(cnr, hc.order = TRUE, type = "lower",
#    outline.col = "black",
#    ggtheme = standard_theme,
#    colors = c('#d8b365', "white", "#de2d26"),p.mat=p.values,lab = TRUE)

# install.packages("corrplot")
# rquery.cormat(dt, type="upper")

res <- dt %>% drop_na(rating_five_count) %>% select(where(is.numeric)) %>% cor()
round(res, 2)
```




```{r}

cnr = dt %>% drop_na(rating_five_count) %>% select(where(is.numeric)) %>% cor()
#p-values matrix
p.values = cor_pmat(dt %>% select(where(is.numeric)))

ggcorrplot(cnr, hc.order = TRUE, type = "lower",
   outline.col = "black",
   # ggtheme = standard_theme,
   colors = c('#d8b365', "white", "#de2d26"),p.mat=p.values,lab = TRUE)



```


Zooming in the plot and we can find - <br>
- strong positive correlation between: shipping option price vs price vs product variation inventory, merchant has profile picture vs shipping option price, rating_X_count has strong correlations with each other, badge fast shipping vs shipping is express (keeping one is enough), countries ship to vs shipping is express , badge product quality vs badge local product, rating vs badges count <br>
- strong negative correlation between: inventory total vs shipping is express vs price <br>
- unexpected correlations: price vs retail price (a lot of discount?), ad boost has barely no correlations with rating or units sold
```{r}
library(corrplot)
corrplot(res, type = "upper", order = "hclust", 
         tl.col = "black", tl.srt = 45)

```





```{r}

dt <- dt %>% mutate(badges_count=factor(badges_count),
                    shipping_option_price=factor(shipping_option_price)) %>% 
    select(-inventory_total)

dt <- dt %>% mutate_if(is.character,as.factor)
```



# Model building with h2o
hasn't started yet because can't install the package
```{r}
# train_split <- sample(seq_len(nrow(dt)),size=round(0.75 * nrow(dt)))
# 
# train <- dt[train_split, ]
# train <- as.h2o(train)
# test <- dt[-train_split, ]
# test <- as.h2o(test)

```





```{r}


```





```{r}


```





```{r}
# check for the number of unique values for each column 
# ulst <- lapply(dt, unique)
# lengths(ulst)
```



```{r}


```




```{r}


```


